name: Encrypt_script

on:
  workflow_dispatch:

jobs:
  encrypt-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache apt dependencies
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-apt-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shc build-essential curl

    - name: Create script file
      run: |
        cat << 'UNIQUE_SCRIPT_END_MARKER' > suksu_setup.sh
        #!/bin/bash
        set -euo pipefail
        
        # ÂÖ®Â±ÄÂèòÈáè
        readonly GITHUB_ENV=${GITHUB_ENV:-".env"}
        readonly REPO_URL="https://raw.githubusercontent.com/Hivensafe/cloud_kernel_enable/main"
        readonly DEMO_REPO="https://github.com/Hivensafe/Demo_kernel.git"
        readonly ANYKERNEL_REPO="https://github.com/showdo/AnyKernel3.git"
        readonly TG_CHANNEL="https://t.me/qdykernel"
        
        # Ê£ÄÊü•ÁéØÂ¢É
        check_environment() {
            if [ "${GITHUB_ACTIONS:-}" != "true" ]; then
                echo "ÈîôËØØÔºöÊ£ÄÊµãÂà∞Èùû GitHub Actions ÁéØÂ¢ÉÔºåÁ¶ÅÊ≠¢Êú¨Âú∞ÊâßË°åÔºÅ"
                exit 1
            fi
        }
        
        # Ê£ÄÊü•ËøúÁ®ãÁä∂ÊÄÅ
        check_remote_status() {
            local flag
            local version
        
            # Ëé∑ÂèñÂêØÁî®Ê†áÂøóÂπ∂ÂéªÊéâ BOM ÂíåÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶
            flag=$(curl -fsSL "${REPO_URL}/enable.txt" | sed -e '1s/^\xEF\xBB\xBF//' | tr -d '[:space:]') || {
                echo "ÈîôËØØÔºöÊó†Ê≥ïËé∑ÂèñÂêØÁî®Ê†áÂøó"
                exit 1
            }
        
            # Ëé∑ÂèñÁâàÊú¨‰ø°ÊÅØÂπ∂ÂéªÊéâ BOM ÂíåÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶
            version=$(curl -fsSL "${REPO_URL}/main_version.txt" | sed -e '1s/^\xEF\xBB\xBF//' | tr -d '[:space:]') || {
                echo "ÈîôËØØÔºöÊó†Ê≥ïËé∑ÂèñÁâàÊú¨‰ø°ÊÅØ"
                exit 1
            }
        
            # Ë∞ÉËØïËæìÂá∫ÔºöÊ£ÄÊü• flag Âíå version ÁöÑÂÄº
            echo "debug = '$flag'"
            echo "debug: version = '$version'"
        
            # Ê£ÄÊü•ÂêØÁî®Ê†áÂøóÊòØÂê¶‰∏∫ "on"
            if [ "$flag" != "on" ]; then
                echo "ÈîôËØØÔºöÊúçÂä°Êú™ÂêØÁî®ÔºåËØ∑ËÅîÁ≥ª‰ΩúËÄÖ"
                echo "TGÈ¢ëÈÅìÔºö${TG_CHANNEL}"
                exit 1
            fi
        
            # Ê£ÄÊü•ÁâàÊú¨ÊòØÂê¶‰∏∫ "10006"
            if [ "$version" != "10006" ]; then
                echo "ÈîôËØØÔºöÂàÜÊîØÂ∑≤ËøáÊúü (ÊúÄÊñ∞: ${version}ÔºåÂΩìÂâç: 10006)"
                echo "ËØ∑ÂêåÊ≠•‰∏äÊ∏∏Êõ¥Êñ∞"
                echo "TGÈ¢ëÈÅìÔºö${TG_CHANNEL}"
                exit 1
            fi
        }


        
        # ËÆæÁΩÆLZ4ÈÖçÁΩÆ
        setup_lz4() {
            echo "Ê≠£Âú®ËÆæÁΩÆLZ4ÈÖçÁΩÆ..."
            # ÂÖãÈöÜ‰ªìÂ∫ì
            if [ ! -d "./Demo_kernel" ]; then
                if ! git clone "${DEMO_REPO}" --depth=1 &>/dev/null; then
                    exit 1
                fi
            fi
        
            # Ê∏ÖÁêÜÂíåÂ§çÂà∂Êñá‰ª∂
            rm -rf Demo_kernel/.git || true
            mkdir -p ./lib/lz4 ./include/linux
        
            if ! cp -r ./Demo_kernel/zram/lz4/* ./lib/lz4/; then
                echo "ÈîôËØØÔºöÂ§çÂà∂lz4Êñá‰ª∂Â§±Ë¥•"
                exit 1
            fi
        
            if ! cp -r ./Demo_kernel/zram/include/linux/* ./include/linux/; then
                echo "ÈîôËØØÔºöÂ§çÂà∂linuxÂ§¥Êñá‰ª∂Â§±Ë¥•"
                exit 1
            fi
        
            if ! cp ./Demo_kernel/zram/6.6/lz4_1.10.0.patch ./; then
                echo "ÈîôËØØÔºöÂ§çÂà∂Ë°•‰∏ÅÊñá‰ª∂Â§±Ë¥•"
                exit 1
            fi
        
            # Â∫îÁî®Ë°•‰∏Å
            if ! patch -p1 -F 3 --fuzz=5 < lz4_1.10.0.patch; then
                echo "Ë≠¶ÂëäÔºöÂ∫îÁî®Ë°•‰∏ÅÊó∂Âá∫Áé∞ÈóÆÈ¢òÔºå‰ΩÜÁªßÁª≠ÊâßË°å..."
            fi
        
            # ‰øÆÊîπMakefile
            local makefile="fs/f2fs/Makefile"
            if [ ! -f "$makefile" ]; then
                echo "ÈîôËØØÔºöÊâæ‰∏çÂà∞Êñá‰ª∂ ${makefile}"
                exit 1
            fi
        
            if ! grep -qF "f2fs-\$(CONFIG_F2FS_IOSTAT) += iostat.o" "$makefile"; then
                echo "f2fs-\$(CONFIG_F2FS_IOSTAT) += iostat.o" >>"$makefile"
                echo "Â∑≤Ê∑ªÂä†: f2fs-\$(CONFIG_F2FS_IOSTAT) += iostat.o"
            else
                echo "Êñá‰ª∂Â∑≤ÁªèÂåÖÂê´: f2fs-\$(CONFIG_F2FS_IOSTAT) += iostat.o"
            fi
        
            echo "LZ4ÈÖçÁΩÆÂÆåÊàê"
        }
        
        # ËÆæÁΩÆGKIÈÖçÁΩÆ
        setup_gki_config() {
            local config=$1
            local defconfig="./common/arch/arm64/configs/gki_defconfig"
        
            if [ ! -f "$defconfig" ]; then
                echo "ÈîôËØØÔºöÊâæ‰∏çÂà∞gki_defconfigÊñá‰ª∂"
                exit 1
            fi
        
            echo "Ê≠£Âú®ÈÖçÁΩÆGKI..."
        
            # Âü∫Êú¨ÈÖçÁΩÆ
            cat <<EOF >>"$defconfig"
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_KSU_MANUAL_HOOK=y
        CONFIG_KPM=y
        CONFIG_CRYPTO_LZ4=y
        CONFIG_CRYPTO_LZ4HC=y
        CONFIG_CRYPTO_LZ4KD=y
        CONFIG_CRYPTO_ZSTD=y
        CONFIG_F2FS_FS_COMPRESSION=y
        CONFIG_F2FS_FS_LZ4=y
        CONFIG_F2FS_FS_LZ4HC=y
        CONFIG_F2FS_FS_ZSTD=y
        CONFIG_KERNEL_LZ4=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS=y
        EOF
        
            # ÁâπÂÆöÈÖçÁΩÆ
            case "$config" in
                BBR)
                    cat <<EOF >>"$defconfig"
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_TCP_CONG_BIC=n
        CONFIG_TCP_CONG_CUBIC=n
        CONFIG_TCP_CONG_WESTWOOD=n
        CONFIG_TCP_CONG_HTCP=n
        CONFIG_DEFAULT_TCP_CONG=bbr
        EOF
                    ;;
                FQ_CODEL)
                    cat <<EOF >>"$defconfig"
        CONFIG_NET_SCH_FQ_CODEL=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_NET_SCH_SFQ=y
        CONFIG_NET_SCH_HTB=y
        CONFIG_NET_SCH_TBF=y
        CONFIG_NET_SCH_SFB=y
        CONFIG_NET_SCH_RED=y
        CONFIG_NET_SCH_INGRESS=y
        CONFIG_DEFAULT_FQ_CODEL=y
        CONFIG_DEFAULT_NET_SCH="fq_codel"
        EOF
                    ;;
                "")
                    echo "‰ΩøÁî®ÈªòËÆ§ÁΩëÁªúÈÖçÁΩÆ"
                    ;;
                *)
                    echo "Ë≠¶ÂëäÔºöÊú™Áü•ÁΩëÁªúÈÖçÁΩÆ ${config}Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ"
                    ;;
            esac
        
            echo "GKIÈÖçÁΩÆÂÆåÊàê"
        }
        
        # Âà∂‰ΩúAnyKernel3ÂåÖ
        make_anykernel3() {
            local kernel_image="kernel_workspace/kernel_platform/common/out/arch/arm64/boot/Image"
            local password='501b10728d2cb08abe16eb8b0bdee33c9d2382e1'
        
            echo "Ê≠£Âú®Âà∂‰ΩúAnyKernel3ÂåÖ..."
        
            if [ ! -f "$kernel_image" ]; then
                echo "ÈîôËØØÔºöÊâæ‰∏çÂà∞ÂÜÖÊ†∏ÈïúÂÉèÊñá‰ª∂ ${kernel_image}"
                exit 1
            fi
        
            if ! git clone "${ANYKERNEL_REPO}" --depth=1; then
                echo "ÈîôËØØÔºöÂÖãÈöÜAnyKernel3‰ªìÂ∫ìÂ§±Ë¥•"
                exit 1
            fi
        
            rm -rf ./AnyKernel3/.git ./AnyKernel3/push.sh
        
            if ! cp "$kernel_image" ./AnyKernel3/; then
                echo "ÈîôËØØÔºöÂ§çÂà∂ÂÜÖÊ†∏ÈïúÂÉèÂ§±Ë¥•"
                exit 1
            fi
        
            if ! 7z a -t7z -p"$password" -mhe=on ./AnyKernel3/TGÈ¢ëÈÅì@qdykernel.7z ./AnyKernel3/Image; then
                echo "ÈîôËØØÔºöÂàõÂª∫7zÂéãÁº©ÂåÖÂ§±Ë¥•"
                exit 1
            fi
        
            rm -f ./AnyKernel3/Image
            echo "AnyKernel3ÂåÖÂà∂‰ΩúÂÆåÊàê"
        }

        # ËÆæÁΩÆBaseband Guard
        baseband_guard() {
            set -e
            # ‰∏ãËΩΩÂâçÊ£ÄÊü•ÈìæÊé•
            if ! curl -I -sSL https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | grep -q "200 OK"; then
                echo "ÈîôËØØÔºöBaseband-guard ‰ªìÂ∫ì‰∏çÂ≠òÂú®ÊàñÊó†Ê≥ïËÆøÈóÆ"
                return 1
            fi
            
            # ‰∏ãËΩΩËÑöÊú¨
            if ! curl -sSL https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh -o setup.sh; then
                echo "ÈîôËØØÔºö‰∏ãËΩΩ setup.sh Â§±Ë¥•"
                return 1
            fi
            
            # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®‰∏îÊúâÊâßË°åÊùÉÈôê
            if [ ! -f "setup.sh" ]; then
                echo "ÈîôËØØÔºösetup.sh Êñá‰ª∂‰∏çÂ≠òÂú®"
                return 1
            fi
            
            chmod +x setup.sh
            
            # Ê£ÄÊü•ÁõÆÊ†áÁõÆÂΩïÊòØÂê¶Â≠òÂú®
            if [ ! -d "./arch/arm64/configs" ]; then
                echo "ÈîôËØØÔºöÁõÆÊ†áÁõÆÂΩï ./arch/arm64/configs ‰∏çÂ≠òÂú®"
                echo "ÂΩìÂâçÁõÆÂΩïÂÜÖÂÆπ:"
                ls -la
                return 1
            fi
            
            # ÊâßË°åËÑöÊú¨
            if ! bash setup.sh; then
                echo "ÈîôËØØÔºöÊâßË°å setup.sh Â§±Ë¥•"
                return 1
            fi
            
            # ËøΩÂä†ÈÖçÁΩÆ
            echo >> ./arch/arm64/configs/gki_defconfig
            echo 'CONFIG_BBG=y' >> ./arch/arm64/configs/gki_defconfig
            echo 'CONFIG_LSM="landlock,lockdown,yama,loadpin,safesetid,selinux,smack,tomoyo,apparmor,bpf,baseband_guard"' >> ./arch/arm64/configs/gki_defconfig
            echo "Baseband Guard ÈÖçÁΩÆÂÆåÊàê"
        }

        # Â∫èÂàóÂè∑Ê£ÄÊü•
        SerialID_Check() {
            local input="$1"
            local suffix="TG@qdykernel"
            local full_hex prefix32
        
            # ËæìÂÖ•È™åËØÅÔºöÊ£ÄÊü•ËÆæÂ§áIDÊòØÂê¶‰∏∫Á©∫
            if [ -z "$input" ]; then
                exit 1
            fi
        
            # Ê£ÄÊü• main.c ÊòØÂê¶Â∑≤ÁªèÂåÖÂê´ patch
            if grep -q 'SOC_SN_CHECK' init/main.c; then
                exit 0
            fi
        
            # Â¶ÇÊûú Demo_kernel Êñá‰ª∂Â§π‰∏çÂ≠òÂú®ÔºåÊâçÂÖãÈöÜ‰ªìÂ∫ì
            if [ ! -d "./Demo_kernel" ]; then
                if ! git clone "${DEMO_REPO}" --depth=1 &>/dev/null; then
                    exit 1
                fi
            fi
        
            # ‰ªé Demo_kernel ‰∏≠Â§çÂà∂ serialid_check.c Êñá‰ª∂
            if ! cp "./Demo_kernel/.github/workflows/tools/serialid_check.c" ./; then
                exit 1
            fi
        
            # ËÆ°ÁÆó sha256 Âπ∂ÂèñÂâç 32 ‰Ωç
            full_hex=$(printf "%s" "${input}${suffix}" | sha256sum | awk '{print $1}')
            prefix32="${full_hex:0:32}"
        
            # Ê†°È™åÂâç32‰ΩçÂêàÊ≥ïÊÄß
            if ! echo "$prefix32" | grep -qE '^[0-9a-f]{32}$'; then
                exit 1
            fi
        
            # ÊõøÊç¢ serialid_check.c ‰∏≠ÁöÑ EXPECTED_ASCII32
            sed -i "s/8f0c3a9b0e2d4f11a0b2c3d4e5f60718/${prefix32}/" serialid_check.c
            
        
            # Êü•ÊâæÂπ∂ÊèíÂÖ• serialid_check.c Âà∞ main.c
            local LINE
            LINE=$(grep -n '^#include' init/main.c | tail -n 1 | cut -d: -f1)
            if [ -z "$LINE" ]; then
                exit 1
            fi
        
            # Â∞Ü serialid_check.c ÊèíÂÖ•Âà∞ main.c
            head -n "$LINE" init/main.c > init/main.c.patched
            cat serialid_check.c >> init/main.c.patched
            tail -n +$((LINE+1)) init/main.c >> init/main.c.patched
            mv init/main.c.patched init/main.c
        }


        # ‰∏ªÁ®ãÂ∫è
        main() {
            check_environment
            check_remote_status
        
            case "$1" in
                setup_lz4)
                    setup_lz4
                    ;;
                setup_gki_config)
                    setup_gki_config "${2:-}"
                    ;;
                make_anykernel3)
                    make_anykernel3
                    ;;
                SerialID_Check)
                    SerialID_Check "$2"
                    ;;
                baseband_guard)
                    baseband_guard
                    ;;
                *)
                    echo "ÈîôËØØÔºåÊú™Áü•ÂèÇÊï∞ $1"
                    exit 1
                    ;;
            esac
        }

        main "$@"
        UNIQUE_SCRIPT_END_MARKER
        
        chmod +x suksu_setup.sh
        echo "‚úÖ Script created successfully"

    - name: Verify script
      run: |
        echo "Verifying script..."
        if ! grep -q "#!/bin/bash" suksu_setup.sh; then
          echo "‚ùå Missing shebang"
          exit 1
        fi
        
        if [ $(wc -l < suksu_setup.sh) -lt 10 ]; then
          echo "‚ùå Script too short"
          exit 1
        fi

    - name: Encrypt script
      run: |
        echo "üîí Starting encryption..."
        
        shc -f suksu_setup.sh -o main.bin -v -r
        
        if [ ! -f "main.bin" ]; then
          echo "‚ùå Encryption failed - no output file"
          exit 1
        fi
        
        echo "Encryption successful"
        echo "File info: $(file main.bin)"
        echo "Size: $(du -h main.bin)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: encrypted-main
        path: main.bin
        retention-days: 7
